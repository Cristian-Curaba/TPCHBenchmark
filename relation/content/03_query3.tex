%!TEX TS-program = pdflatex
%!TEX root = ../main.tex
%!TEX encoding = UTF-8 Unicode


\section{Returned item loss}

It is asked to retrieve the \textit{revenue loss} for customers who might be having problems with the parts that are shipped to them, where a \textit{revenue loss} is defined as \texttt{SUM(l\_extendedprice*(1-l\_discount))} for all qualifying \textit{lineitems}.

\subsection{Na\"{i}ve implementation}

\begin{lstlisting}
WITH lineitem_orders AS (
	SELECT 
		o_orderkey, 
		l_partkey, 
		l_suppkey, 
		o_orderdate, 
		o_custkey, 
		l_extendedprice, 
		l_discount, 
		l_returnflag,
		l_commitdate,
		l_receiptdate
	FROM lineitem JOIN orders ON (l_orderkey = o_orderkey)
),
query3 AS (
SELECT
	EXTRACT (YEAR FROM o_orderdate) AS _year,
	EXTRACT (QUARTER FROM o_orderdate) AS _quarter,
	EXTRACT (MONTH FROM o_orderdate) AS _month,
	c_name,
	SUM(l_extendedprice * (1 - l_discount)) AS returnloss
FROM
	lineitem_orders
	JOIN customer ON o_custkey = c_custkey
WHERE 
	l_returnflag = 'R'
	-- AND c_name = 'Customer#000129976'
	-- AND EXTRACT (QUARTER FROM o_orderdate) = 1
GROUP BY
	_year,
	_quarter,
	_month,
	c_custkey,
	c_name
)
SELECT * FROM query3;
\end{lstlisting}
