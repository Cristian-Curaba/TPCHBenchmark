%!TEX TS-program = pdflatex
%!TEX root = ../main.tex
%!TEX encoding = UTF-8 Unicode


\section{Materialization}
\label{section:materialization}

After a study on the given set of queries, some common intermediate results have been detected between the three. In order to try lowering the average execution cost, materialized views have been defined starting from the said results.

Furthermore, since the problem considers dealing with a data warehouse (OLAP), there won't be frequent updates, so materialized views are a smart choice.

\subsection{Lineitem - Orders View}
Since all the queries perform a join between relations \textit{lineitem} and \textit{orders}, an idea is to pre-process this join by creating a materialized view.

\begin{lstlisting}
CREATE MATERIALIZED VIEW lineitem_orders_mv AS
	SELECT 
		o_orderkey, 
		l_partkey, 
		l_suppkey, 
		o_orderdate, 
		o_custkey, 
		l_extendedprice, 
		l_discount, 
		l_returnflag,
		l_commitdate,
		l_receiptdate
	FROM lineitem JOIN orders ON (l_orderkey = o_orderkey);
\end{lstlisting}

This materialized view is composed by \num{59986052} rows, and weighs \SI{4378}{\mega\byte}.

\subsubsection{Customer - Location View}
Queries 1 and 2 execute a join operation between \textit{customer}, \textit{nation} and \textit{region}, also this step has been pre-processed by creating a materialized view.

\begin{lstlisting}
CREATE MATERIALIZED VIEW customer_location_mv AS
	SELECT 
		c_custkey, 
		c_name, 
		n_nationkey AS c_nationkey, 
		n_name AS c_nationname, 
		r_regionkey AS c_regionkey, 
		r_name AS c_regionname 
	FROM customer 
		JOIN nation ON (c_nationkey = n_nationkey)
		JOIN region ON (n_regionkey = r_regionkey);
\end{lstlisting}

This materialized view is composed by \num{1500000} rows, and weighs \SI{167}{\mega\byte}.

\subsubsection{Supplier - Location View}
Finally, queries 1 and 2 execute a join operation between \textit{supplier}, \textit{nation} and \textit{region}, also this step has been pre-processed by creating a materialized view.

\begin{lstlisting}
-- used by Q1 and Q2
CREATE MATERIALIZED VIEW supplier_location_mv AS
	SELECT 
		s_suppkey, 
		s_name, 
		n_nationkey AS s_nationkey, 
		n_name AS s_nationname, 
		r_regionkey AS s_regionkey, 
		r_name AS s_regionname 
	FROM supplier 
		JOIN nation ON (s_nationkey = n_nationkey)
		JOIN region ON (n_regionkey = r_regionkey);
\end{lstlisting}

This materialized view is composed by \num{100000} rows, and weighs \SI{12}{\mega\byte}.

\subsection{Execution times}

As for the base versions of queries, we collected statistics on execution timings and results can be observed on \autoref{tab:materializationstimings}. Further considerations are reported in the \autoref{section:conclusions}.

\begin{table}[!h]
\centering
\begin{tabular}{|| c | c c c c c | c c ||} 
 \hline
 Query & Run 1 & Run 2 & Run 3 & Run 4 & Run 5 & 	$\mu$ & $\sigma$ \\ [0.5ex] 
 \hline\hline
 1 & \num{16207} & \num{15048} & \num{15257} & \num{15421} & \num{15028} & \num{15392} & \num{483} \\ 
 \hline
 2 & \num{14957} & \num{17235} & \num{15519} & \num{16654} & \num{16400} & \num{16153} & \num{910} \\ 
 \hline
 3 & \num{13742} & \num{15604} & \num{14050} & \num{14822} & \num{14822} & \num{14608} & \num{732} \\ 
 \hline
\end{tabular}
  \caption{Query timings with materialized views, in milliseconds.}
  \label{tab:materializationstimings}
\end{table}